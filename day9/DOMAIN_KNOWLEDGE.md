# 도메인 지식: Reth 헤더 버퍼 심층 탐구 (초보자 가이드)

이 문서는 Reth의 헤더 동기화 파이프라인을 축약한 `HeaderBuffer` 과제를 이해하는 데 필요한 핵심 도메인 지식을 설명합니다. 블록체인 클라이언트, 특히 Ethereum의 동기화 과정에 익숙하지 않은 개발자를 위해 개념을 상세히 풀어썼습니다.

---

## 1. 왜 '헤더'부터 동기화해야 할까? (The Big Picture)

Ethereum 노드가 네트워크에 처음 참여하면, 가장 먼저 해야 할 일은 지금까지 쌓인 모든 블록 데이터를 내려받아 최신 상태를 따라잡는 것입니다. 이를 **동기화(Synchronization)**라고 합니다.

수백만 개에 달하는 블록 전체를 한 번에 다운로드하고 검증하는 것은 매우 비효율적입니다. 블록 하나는 `헤더(Header)`와 `바디(Body)`로 구성되는데, 바디에는 수많은 트랜잭션 데이터가 포함되어 용량이 매우 큽니다.

Reth와 같은 현대적인 클라이언트는 이 문제를 해결하기 위해 **파이프라인(Pipeline)** 방식을 사용합니다. 동기화 과정을 여러 단계(Stage)로 나누어 병렬로 처리하는 것입니다.

> **비유: 건물 짓기**
> 1.  **헤더 동기화**: 건물의 뼈대(철골 구조)를 먼저 빠르게 올립니다. 각 층의 위치, 높이, 설계도가 맞는지 확인하며 전체 구조를 잡습니다.
> 2.  **바디 동기화**: 뼈대가 완성되면, 각 층에 콘크리트를 붓고 벽을 세우는 작업을 합니다. (트랜잭션 데이터 다운로드)
> 3.  **실행**: 내부 설비(전기, 수도)를 연결하고 인테리어를 합니다. (트랜잭션을 실행하여 계정 상태 변경)

`HeaderBuffer`는 바로 이 첫 번째 단계, 즉 **체인의 뼈대를 구축하는 과정**을 메모리에서 효율적으로 처리하는 방법을 모델링합니다. 헤더는 크기가 작기 때문에 매우 빠르게 다운로드하여 체인의 전체 구조, 분기(fork), 길이를 파악할 수 있습니다.

**핵심 이점:**
- **속도**: 무거운 바디를 제외하고 헤더만 먼저 처리하므로 동기화 초기 단계가 매우 빠릅니다.
- **효율성**: 잘못된 체인(예: 공격자의 체인)에 연결되었을 경우, 비싼 비용을 치르고 바디까지 받은 후에야 알아차리는 낭비를 막을 수 있습니다. 헤더만 보고도 체인의 유효성을 상당 부분 검증할 수 있기 때문입니다.
- **자원 절약**: 후속 단계(바디 다운로드, 실행)가 어떤 데이터를 어디서 가져와야 할지 미리 알 수 있어 디스크 I/O와 계산 자원을 아낄 수 있습니다.

---

## 2. `HeaderBuffer`의 핵심 구성 요소: 무엇을, 왜 저장하는가?

본 과제의 `HeaderBuffer`는 Reth의 실제 데이터베이스 테이블과 메모리 상태를 단순화한 모델입니다.

| `HeaderBuffer` 필드         | 대응하는 Reth 컴포넌트        | 역할과 존재 이유                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 -
| `canonical: Vec<BlockHeader>` | `CanonicalHeaders` DB 테이블 | **정식 체인(Canonical Chain)**을 나타냅니다. 정식 체인이란, 네트워크가 '올바르다'고 합의한 단 하나의 블록 시퀀스입니다. 이 벡터의 인덱스는 블록 번호(block number)와 일치하여, `canonical[5]`는 5번 블록의 헤더를 의미합니다.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        -
| `index_by_hash: HashMap<String, usize>` | `Headers` DB 테이블의 인덱스 | 블록 해시를 `canonical` 벡터의 인덱스(즉, 블록 번호)로 매핑합니다. 헤더에는 '부모 블록의 해시'가 포함되는데, 이 맵을 사용하면 O(1)의 매우 빠른 속도로 부모 블록이 우리 버퍼에 존재하는지, 존재한다면 몇 번 블록인지 즉시 찾을 수 있습니다.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    -
| `total_difficulty: u128`      | `HeaderTD` DB 테이블         | **누적 총 난이도(Total Difficulty)**를 추적합니다. PoW(작업증명) 체인에서 난이도는 블록을 찾는 데 필요한 계산의 어려움을 나타냅니다. 총 난이도는 제네시스부터 현재 블록까지 모든 블록의 난이도를 더한 값입니다. 이 값이 가장 큰 체인이 가장 많은 '작업'이 투입된 체인으로 인정받아 정식 체인이 됩니다. `u128`을 쓰는 이유는 `u64`인 개별 난이도의 합이 오버플로될 수 있기 때문입니다. |

---

## 3. 제네시스 블록: 모든 것의 시작

**제네시스(Genesis) 블록**은 체인의 첫 번째 블록(0번 블록)입니다. 이 블록은 다른 블록처럼 채굴되는 것이 아니라, 클라이언트 소프트웨어에 **하드코딩**되어 있습니다.

> **비유: 헌법 제1조**
> 제네시스 블록은 국가의 헌법 제1조와 같습니다. 모든 법률이 헌법에 기초하듯, 모든 블록은 제네시스 블록에서부터 파생됩니다. 누구도 이 기준 자체를 바꿀 수 없으며, 모든 네트워크 참여자가 동일한 제네시스 블록을 공유함으로써 합의의 기반을 마련합니다.

`HeaderBuffer`를 초기화할 때 제네시스 헤더를 즉시 `canonical` 목록에 추가하고 인덱스를 만드는 이유가 바로 이것입니다. 이후 들어오는 모든 헤더(1번, 2번, ...)는 이 절대적인 기준점과의 연결성을 검증받아야 합니다.

---

## 4. 새로운 헤더를 수용하기 위한 검증 과정 (단계별 분석)

새로운 헤더를 받았을 때, `try_append` 함수는 아래와 같은 엄격한 검증 시퀀스를 수행합니다. 하나라도 통과하지 못하면 헤더는 버려집니다.

1.  **해시 중복 검사 (`DuplicateHash`)**
    -   **무엇을 하나?**: 새로 받은 헤더의 해시가 `index_by_hash` 맵에 이미 있는지 확인합니다.
    -   **왜 필요한가?**: 블록 해시는 각 블록의 고유한 식별자(ID)여야 합니다. 만약 동일한 해시가 이미 존재한다면, 이는 동일한 블록을 두 번 받으려 하거나, 해시 충돌(이론적으로 거의 불가능)이 발생했음을 의미합니다. 어느 쪽이든 비정상적인 상황이므로 즉시 거부해야 합니다.

2.  **부모 존재 확인 (`ParentNotFound`)**
    -   **무엇을 하나?**: 새 헤더의 `parent_hash` 필드에 기록된 해시가 `index_by_hash` 맵에 있는지 확인합니다.
    -   **왜 필요한가?**: 블록체인은 이름 그대로 블록들이 '체인'처럼 연결된 구조입니다. 모든 블록(제네시스 제외)은 반드시 부모 블록을 가져야 합니다. 만약 부모를 찾을 수 없다면, 이 헤더는 연결할 곳이 없는 **고아(Orphan) 블록**입니다. 이는 우리가 아직 부모 블록을 다운로드하지 않았거나, 완전히 다른 체인에 속한 블록일 수 있습니다.

3.  **블록 번호 연속성 검사 (`NumberMismatch`)**
    -   **무엇을 하나?**: 부모 블록의 번호 + 1이 새 헤더의 블록 번호와 일치하는지 확인합니다.
    -   **왜 필요한가?**: 블록체인은 1, 2, 3, ... 순서로 번호가 매겨진 장부입니다. 만약 100번 블록 다음에 102번 블록이 오려고 한다면, 중간에 101번 블록이 누락된 것입니다. 이런 "구멍"이 생기면 체인의 무결성이 깨지므로, 파이프라인은 데이터가 순차적으로 완전하게 연결되는지 보장해야 합니다.

4.  **상태 갱신 (검증 통과 시)**
    -   검증을 모두 통과한 헤더는 '신뢰할 수 있는' 헤더입니다.
    -   `canonical` 벡터에 추가됩니다. (`push`)
    -   `index_by_hash` 맵에 새 헤더의 해시와 번호가 등록됩니다.
    -   `total_difficulty`에 새 헤더의 난이도 값을 더합니다.
    -   이 모든 과정은 원자적(atomic)으로 일어나야 합니다. Reth에서는 데이터베이스 트랜잭션으로 묶여 처리됩니다.

---

## 5. 총 난이도(Total Difficulty)와 체인 선택 (Fork Choice Rule)

블록체인은 항상 일렬로만 성장하지 않습니다. 때로는 거의 동시에 두 명의 채굴자가 서로 다른 블록을 만들어낼 수 있습니다. 이때 체인은 두 갈래로 나뉘는데, 이를 **포크(Fork)**라고 합니다.

> **예시:**
> 정식 체인: `A -> B -> C`
> 이때, 두 채굴자가 C 다음에 붙는 블록 D1과 D2를 거의 동시에 생성합니다.
> -   포크 1: `A -> B -> C -> D1`
> -   포크 2: `A -> B -> C -> D2`

어느 쪽을 따라가야 할까요? PoW(작업증명) 기반의 이더리움은 **"가장 긴 체인" 규칙**을 따릅니다. 하지만 '길이'는 블록의 개수가 아니라, **누적 총 난이도(Total Difficulty)**로 측정합니다. 더 많은 해시 파워(작업량)가 투입된 체인이 더 '길고' 안전하다고 간주하는 것입니다.

`HeaderBuffer`가 `total_difficulty`를 계속 추적하는 이유는 바로 이 때문입니다. 다른 피어로부터 우리와 다른 체인 정보를 받았을 때, `total_difficulty`를 비교하여 어떤 체인이 정식 체인인지 빠르고 효율적으로 판단할 수 있습니다.

(참고: 현재 이더리움은 PoS(지분증명)로 전환되었지만, PoW 시절의 데이터를 동기화하거나 특정 상황에서 여전히 이 개념이 중요하게 사용됩니다.)

---

## 6. 다른 Stage와의 연결점: 우리는 무엇을 준비해야 하는가?

헤더 Stage는 독립적으로 존재하지 않습니다. 후속 Stage를 위한 데이터를 준비하는 중요한 역할을 합니다.

-   **To: 바디 다운로드 Stage (Body Download Stage)**
    -   **역할**: 헤더 Stage가 검증한 `canonical` 목록을 보고, 각 블록 번호에 해당하는 블록 바디(트랜잭션 목록)를 다른 피어에게 요청하여 다운로드합니다.
    -   **필요한 API**: `HeaderBuffer`는 "500번 블록의 해시는 무엇인가?"와 같은 질문에 답할 수 있어야 합니다. (`fn get_hash_by_number(number)`)

-   **To: 실행 Stage (Execution Stage)**
    -   **역할**: 다운로드된 블록(헤더+바디)을 가져와 트랜잭션을 하나씩 실행하며, 모든 계정의 잔액과 상태를 최종적으로 변경(State Transition)합니다.
    -   **필요한 API**: 실행 Stage는 "1000번 블록부터 최신 블록까지 헤더 목록을 순서대로 달라"고 요청할 수 있어야 합니다. (`fn iter_since(number)`)

이처럼 `HeaderBuffer`는 후속 Stage들이 신뢰하고 사용할 수 있는 **정확하고 일관된 체인 뷰**를 제공해야 하는 책임을 가집니다.

---

## 7. 메모리 버퍼의 한계와 실제 클라이언트의 전략

`HeaderBuffer`는 메모리에서 동작하므로 매우 빠르지만, 프로세스가 종료되면 모든 데이터가 사라집니다. 실제 클라이언트는 영속성(persistence)을 위해 다음과 같은 전략을 사용합니다.

1.  **주기적인 플러시(Flush)**: 메모리 버퍼에 쌓인 검증된 헤더들을 주기적으로 디스크의 데이터베이스(Reth는 MDBX 사용)에 저장합니다.
2.  **재시작 시 복원**: 클라이언트가 재시작되면, 디스크 데이터베이스에서 마지막으로 저장된 헤더들을 읽어와 메모리 `HeaderBuffer`를 다시 채웁니다. 이를 통해 중단된 지점부터 동기화를 재개할 수 있습니다.
3.  **하이브리드 전략**: 수백만 개의 헤더를 모두 메모리에 올리는 것은 비효율적이므로, 보통 최근 N개의 블록(예: 최근 10,000개)만 메모리에 유지하고, 그 이전의 오래된 헤더는 필요할 때 디스크에서 직접 조회하는 방식을 사용합니다.

---

## 8. 다음 단계를 위한 아이디어와 학습 자료

이 `HeaderBuffer`를 기반으로 전체 클라이언트 파이프라인을 상상해보며 다음과 같은 기능을 확장해볼 수 있습니다.

-   **조회 API 추가**:
    -   `fn get_header_by_hash(hash: &str) -> Option<&BlockHeader>`
    -   `fn get_header_by_number(number: u64) -> Option<&BlockHeader>`
-   **포크 재구성(Reorg) API**:
    -   `fn unwind_to(block_number: u64)`: 특정 블록 번호까지 체인을 되돌리는 기능. 더 강력한 포크가 나타났을 때 기존 체인을 버리고 새로운 체인으로 갈아타기 위해 필요합니다.
-   **오류 처리 및 로깅 개선**:
    -   `ParentNotFound` 오류가 발생했을 때, 어떤 부모 해시를 찾지 못했는지 로그에 남기면 디버깅에 매우 유용합니다.

#### 추천 학습 자료:
-   **Reth 아키텍처 문서**:
    -   [The Reth Book: Pipeline](https://reth.rs/design/stages/pipeline.html): Stage 파이프라인의 전체적인 설계를 이해할 수 있습니다.
    -   [The Reth Book: Header Stage](https://reth.rs/design/stages/headers.html): 실제 헤더 Stage의 더 상세한 동작 원리를 설명합니다.
-   **이더리움 명세**:
    -   [Ethereum Yellow Paper](https://ethereum.github.io/yellowpaper/paper.pdf): 특히 섹션 4.3 (Blocks, State and Transactions)은 블록의 구조를 이해하는 데 도움이 됩니다.
-   **관련 블로그 글**:
    -   [Paradigm: Inside Reth’s Pipeline](https.paradigm.xyz/2023/10/reth-pipeline): Reth 파이프라인의 내부 동작을 심도 있게 다룹니다.